% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/main.R
\name{Run.Consistency}
\alias{Run.Consistency}
\title{Run Consistency Analysis on Single-Cell Data}
\usage{
Run.Consistency(
  scTypeEval,
  ident = NULL,
  sample = NULL,
  normalization.method = c("Log1p", "CLR", "pearson"),
  gene.list = NULL,
  pca = FALSE,
  ndim = 30,
  distance.method = "euclidean",
  IntVal.metric = c("silhouette", "NeighborhoodPurity", "ward.PropMatch",
    "Leiden.PropMatch", "modularity"),
  data.type = c("sc", "pseudobulk", "pseudobulk_1vsall"),
  min.samples = 5,
  min.cells = 10,
  KNNGraph_k = 5,
  black.list = NULL,
  ncores = 1,
  bparam = NULL,
  progressbar = TRUE,
  verbose = TRUE
)
}
\arguments{
\item{scTypeEval}{A scTypeEval object containing single-cell expression data, metadata, and gene lists.}

\item{ident}{Character. Name of the column in \code{scTypeEval@metadata} containing the cell type labels.
If \code{NULL}, defaults to \code{scTypeEval@active.ident}.}

\item{sample}{Character. Name of the column in \code{scTypeEval@metadata} containing sample identifiers.
Required for pseudobulk analyses.}

\item{normalization.method}{Character. Method for normalizing the expression data. See \link[add.HVG]{add.HVG} for more details.
Options: \code{"Log1p"}, \code{"CLR"}, \code{"pearson"}. Default: \code{"Log1p"}.}

\item{gene.list}{List. A list of gene sets to compute consistency metrics on.
By default, each of the gene lists stored in \code{scTypeEval} are used recursively to compute consitency metrics.}

\item{pca}{Logical. Whether to perform PCA before computing metrics. Default: \code{FALSE}.
\code{FALSE} will build consistency metrics directly on the genes within \code{gene.list}, while \code{TRUE} will do it on their principal components.}

\item{ndim}{Integer. Number of PCA dimensions to use to compute metrics if \code{pca = TRUE}. Default: \code{30}.}

\item{distance.method}{Character. Distance metric to use. Must be one of the predefined methods. Default: \code{"euclidean"}.
Supported options:
\itemize{
\item \code{"euclidean"}: Standard Euclidean distance, commonly used for measuring dissimilarity in high-dimensional spaces.
\item \code{"EMD"}: Earth Mover's Distance, computationally expensive but useful for comparing distributions (only recommended for pseudobulk data).
\item \code{"maximum"}: Chebyshev distance, considers the largest absolute difference across dimensions.
\item \code{"manhattan"}: Sum of absolute differences, often preferred when dealing with sparse data.
\item \code{"canberra"}: Weighted Manhattan distance, emphasizing smaller values.
\item \code{"binary"}: Simple matching coefficient for binary presence/absence data.
\item \code{"minkowski"}: Generalized distance metric (Manhattan and Euclidean are special cases).
\item \code{"Jaccard"}: Measures dissimilarity between binary vectors.
\item \code{"Weighted_Jaccard"}: Variant of Jaccard similarity that accounts for weighting.
\item \code{"gower"}: Distance measure handling mixed binary raw + normalized matrices.
\item \code{"bray-curtis"}: Measures dissimilarity between samples based on abundance.
\item \code{"cosine"}: Measures the cosine of the angle between two vectors.
\item \code{"pearson"}: Pearson correlation distance (1 - correlation coefficient).
}}

\item{IntVal.metric}{Character vector. Internal validation metrics to compute. By default, the following metrics will be run:
\code{"silhouette"}, \code{"NeighborhoodPurity"}, \code{"ward.PropMatch"}, \code{"Leiden.PropMatch"}, \code{"modularity"}.
All available options:
\itemize{
\item \code{"silhouette"}: Contrast intra-cluster tightness with inter-cluster separation. (Distance-based, Mean silhouette width per cell type)
\item \code{"modularity"}: Strength of intra-community density compared to random expectation in a network. (Graph structure, Global modularity score and per-cell-type modularity contribution)
\item \code{"ward.PropMatch"}: Normalized proportion of reference labels in the dominant cluster by Ward (Clustering-based, Proportion match of dominant labels within hierarchical clusters)
\item \code{"ward.NMI"}: Normalized shared information between Ward clusters and reference labels. (Global level metric)
\item \code{"ward.ARI"}: Adjusted Rand Index for Ward clustering. (Global level metric)
\item \code{"Leiden.PropMatch"}: Normalized proportion of reference labels in the dominant Leiden clustering. (Clustering-based, Local agreement)
\item \code{"Leiden.NMI"}: Normalized Mutual Information for Leiden partitions. (Global level metric)
\item \code{"Leiden.ARI"}: Adjusted Rand Index for Leiden clustering. (Global level metric)
\item \code{"NeighborhoodPurity"}: Proportion of K-Nearest Neighbors sharing the same label. (Local agreement, Mean proportion of neighbors sharing same identity)
\item \code{"GraphConnectivity"}: Proportion of elements within a group that belong to its largest connected component. (Graph structure, Size of the largest connected component relative to reference group size)
\item \code{"inertia"}: Sum of squared distances from points to their assigned cluster centroid. (Distance-based)
\item \code{"Xie-Beni"}: Ratio of intra-cluster dispersion to inter-cluster separation. (Distance-based)
\item \code{"S_Dbw"}: Internal cluster validity index combining density and separation. (Distance-based)
\item \code{"I"}: Trade-off between separation and cohesion in clusters. (Distance-based)
}}

\item{data.type}{Character. Type of data input to perform.
Options, one of:
\itemize{
\item \code{"sc"}: Single-cell data, where each cell is treated as an individual observation.
\item \code{"pseudobulk"}: Aggregated expression values per cell type and sample, useful to capture inter-sample variability.
\item \code{"pseudobulk_1vsall"}: Pseudobulk comparisons where each cell type is analyzed against all others, useful for detecting cell-type-specific consistency.
Default: \code{"sc"}.
}}

\item{min.samples}{Integer. Minimum number of samples required for intersample comparisons. Default: \code{5}.}

\item{min.cells}{Integer. Minimum number of cells required per population. Default: \code{10}.}

\item{KNNGraph_k}{Integer. Number of neighbors to consider in k-NN graph calculations. Default: \code{5}.}

\item{black.list}{Character vector. Genes to exclude from consistency analysis. Defaults to \code{scTypeEval@black.list}.}

\item{ncores}{Integer. Number of CPU cores to use for parallel processing. Default: \code{1}.}

\item{bparam}{Parallel backend parameter object for BiocParallel. If provided, overrides \code{ncores}.}

\item{progressbar}{Logical. Whether to display a progress bar during computation. Default: \code{TRUE}.}

\item{verbose}{Logical. Whether to print messages during execution. Default: \code{TRUE}.}
}
\value{
An updated \code{scTypeEval} object with consistency metrics stored in \code{consistency} slot.
}
\description{
Computes internal validation consistency metrics for cell type annotations
in single-cell RNA-seq datasets. This function evaluates the robustness of annotations
using various distance metrics, normalization methods, and gene sets.
}
\details{
The function evaluates the consistency of cell type annotations using internal validation metrics.
If \code{sample} is provided, it performs inter-sample consistency analysis (pseudobulk modes require multiple samples).
The function supports different validation metrics, including silhouette score,
network modularity, and nearest-neighbor-based purity measures. Users can specify a gene set
for evaluation and optionally apply PCA before computing consistency metrics.
Parallel processing is enabled when \code{ncores > 1}, using BiocParallel for efficiency.
}
\examples{
\dontrun{
# Run consistency analysis on single-cell data
sceval <- Run.Consistency(
  scTypeEval = sceval,
  ident = "cell_type",
  sample = "patient_id",
  normalization.method = "Log1p",
  IntVal.metric = c("silhouette", "modularity"),
  data.type = "pseudobulk",
  ncores = 2
)
}

}
